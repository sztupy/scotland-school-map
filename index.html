<!DOCTYPE html>
<html>

<head>
    <title>Primary and Secondary School ranking map of Scotland</title>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width,
        initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css" />

    <meta property="og:title" content="Primary and secondary school ranking map of Scotland">
    <meta property="og:type" content="website" />
    <meta property="og:description"
        content="Map of primary and secondary schools of Scotland from https://datamap-scotland.co.uk/ overlaid on a single map.">
    <meta property="og:image" content="https://sztupy.hu/scotland-school-map/preview.png">
    <meta property="og:url" content="https://sztupy.hu/scotland-school-map/">


    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            right: 0;
            bottom: 0;
            left: 0;
            top: 0;
        }

        .leaflet-popup-content {
            max-height: 10em;
            overflow: auto;
        }
    </style>
</head>

<body>
    <div class="folium-map" id="map"></div>
    <script src="output.js"></script>
    <script>
        let map = L.map(
            "map",
            {
                center: [57.0, -4.7],
                crs: L.CRS.EPSG3857,
                zoom: "6.5",
                zoomControl: true,
                preferCanvas: false,
            }
        );

        let tileLayer = L.tileLayer(
            "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            { "attribution": "Data by \u0026copy; \u003ca href=\"http://openstreetmap.org\"\u003eOpenStreetMap\u003c/a\u003e, under \u003ca href=\"http://www.openstreetmap.org/copyright\"\u003eODbL\u003c/a\u003e.", "detectRetina": false, "maxNativeZoom": 18, "maxZoom": 18, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false }
        ).addTo(map);

        let secondaryFeatures = [];
        let primaryFeatures = [];

        for (let i=0; i<10; i++) {
            secondaryFeatures.push(new L.featureGroup({}).addTo(map));
            primaryFeatures.push(new L.featureGroup({}).addTo(map))
        }


        function catchmentPopup(feature, layer) {
            if (feature.properties) {
                let text = '';
                for (let key of Object.keys(feature.properties).sort()) {
                    if (feature.properties[key] != null) {
                        text += `<b>${key}</b>: ${feature.properties[key]}<br>`;
                    }
                }
                layer.bindPopup(text);

                let toolTipText = `${feature.properties["Schoolname"]}<br>`;

                if (feature.properties["5 And Above20202021"] != null) {
                    toolTipText += `Success rate: ${feature.properties["5 And Above20202021"]}%`;
                }
                layer.bindTooltip(toolTipText, { sticky: true });
            }
        }

        let catchmentFeatures = [];

        map_data.catchment.sort((a,b) => (a.properties["5 And Above20202021"]||0) - (b.properties["5 And Above20202021"]||0))

        for (let catchmentArea of map_data.catchment) {
            let feature = {
                type: "Feature",
                properties: catchmentArea.properties,
                geometry: catchmentArea.geometry
            }

            let value = catchmentArea.properties["5 And Above20202021"];
            let color = 240;
            if (value != null) {
                if (value < 30) {
                    color = 0;
                } else if (value > 70) {
                    color = 120;
                } else {
                    color = (value-30) * 3;
                }
            }
            let rank = 0;
            if (value != null) {
                rank = Math.floor(value / 10);
                if (rank<1) rank = 1;
            }

            let settings = {
                style: {
                    color: 'black',
                    fillColor: `hsl(${color}, 50%, 50%)`,
                    opacity: 1,
                    weight: 0.5,
                    fillOpacity: 0.5
                },
                onEachFeature: catchmentPopup
            }
            catchmentFeatures.push(new L.GeoJSON(feature, settings).addTo(secondaryFeatures[rank]));
        }

        for (let secondarySchool of map_data.secondary_schools) {
            let point = [secondarySchool[1], secondarySchool[0]];
            let settings = {
                radius: 6,
                color: "black",
                fillColor: secondarySchool[2].type == 'Non-denominational' ? `black` : `white`,
                fillOpacity: 0.5,
                weight: 4
            }
            let name = secondarySchool[2].name;
            let value = secondarySchool[2]["5 And Above20202021"];
            let rank = 0;
            if (value != null) {
                rank = Math.floor(value / 10);
                if (rank<1) rank = 1;
            }

            let text = '';
            for (let key of Object.keys(secondarySchool[2]).sort()) {
                if (secondarySchool[2][key] != null) {
                    text += `<b>${key}</b>: ${secondarySchool[2][key]}<br>`;
                }
            }

            new L.CircleMarker(point, settings).addTo(secondaryFeatures[rank]).bindTooltip(`${name}<br>Success Rate: ${value}%`, { sticky: true }).bindPopup(text);
        }

        for (let primarySchool of map_data.primary_schools) {
            let point = [primarySchool[1], primarySchool[0]];
            let settings = {
                radius: 4,
                color: "black",
                fillColor: `hsl(${135-primarySchool[2].rank*15}, 100%, 50%)`,
                fillOpacity: 1,
                weight: 0.5
            }
            let name = primarySchool[2].name;
            let successRateMin = (10-primarySchool[2].rank) * 10;
            let successRateMax = (10-primarySchool[2].rank) * 10 + 10;
            if (successRateMin == 10) successRateMin = 0;

            let text = '';
            for (let key of Object.keys(primarySchool[2]).sort()) {
                if (primarySchool[2][key] != null) {
                    text += `<b>${key}</b>: ${primarySchool[2][key]}<br>`;
                }
            }

            new L.CircleMarker(point, settings).addTo(primaryFeatures[primarySchool[2].rank]).bindTooltip(`${name}<br>Success rate: ${successRateMin} - ${successRateMax}%`, { sticky: true }).bindPopup(text);
        }


        let layerControl = {
                base_layers : {
                    "openstreetmap" : tileLayer,
                },
                overlays :  {
                    "Primary Above 90%" : primaryFeatures[1],
                    "Primary Above 80%" : primaryFeatures[2],
                    "Primary Above 70%" : primaryFeatures[3],
                    "Primary Above 60%" : primaryFeatures[4],
                    "Primary Above 50%" : primaryFeatures[5],
                    "Primary Above 40%" : primaryFeatures[6],
                    "Primary Above 30%" : primaryFeatures[7],
                    "Primary Above 20%" : primaryFeatures[8],
                    "Primary Below 20%" : primaryFeatures[9],
                    "Secondary Above 90%" : secondaryFeatures[9],
                    "Secondary Above 80%" : secondaryFeatures[8],
                    "Secondary Above 70%" : secondaryFeatures[7],
                    "Secondary Above 60%" : secondaryFeatures[6],
                    "Secondary Above 50%" : secondaryFeatures[5],
                    "Secondary Above 40%" : secondaryFeatures[4],
                    "Secondary Above 30%" : secondaryFeatures[3],
                    "Secondary Above 20%" : secondaryFeatures[2],
                    "Secondary Below 20%" : secondaryFeatures[1],
                    "Secondary Unknown" : secondaryFeatures[0],
                },
            };
            L.control.layers(
                layerControl.base_layers,
                layerControl.overlays,
                {"hideSingleBase": true, "autoZIndex": true, "collapsed": true, "position": "topright"}
            ).addTo(map);

    </script>
</body>

</html>
